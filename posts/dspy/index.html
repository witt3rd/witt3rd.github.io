<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Donald Thompson">
<meta name="dcterms.date" content="2024-05-07">

<title>witt3rd.github.io - DSPy Tutorial</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">witt3rd.github.io</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/witt3rd"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/dt_public"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/thompsondonald/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">DSPy Tutorial</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">code</div>
                <div class="quarto-category">tutorial</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Donald Thompson </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 7, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="dspy" class="level1">
<h1>DSPy</h1>
<p><a href="https://github.com/stanfordnlp/dspy">DSPy</a> is a new framework for developing applications using large language models (LLMs) that aims to solve the fragility and complexity issues of traditional LLM-based pipelines. It aims to make building complex, multi-step LLM applications more straightforward and robust by providing a declarative programming model and automated optimization capabilities.</p>
<ul>
<li>DSPy provides a declarative, composable, and Pythonic syntax for building LLM-based programs, replacing the need for manual prompt engineering</li>
<li>DSPy includes an “automatic compiler” that can optimize the prompts, instructions, and LM weights for each component of an LLM program, improving the overall quality and efficiency</li>
<li>DSPy allows chaining together multiple LLM calls into a program, where the output of one LLM call becomes the input to the next</li>
<li>DSPy introduces abstractions like “Signatures” to cleanly represent the input/output specifications of each LLM component</li>
<li>DSPy is positioned as a more structured and programmable alternative to other LLM integration frameworks like LangChain</li>
</ul>
<section id="language-models" class="level2">
<h2 class="anchored" data-anchor-id="language-models">Language Models</h2>
<p>In DSPy, a Language Model (LM) is a key component used to perform various tasks such as answering questions, generating text, and making predictions. Some key points about LMs in DSPy:</p>
<ul>
<li>DSPy supports using both remote LMs managed as services (e.g.&nbsp;OpenAI, Cohere, Anthropic) and local LMs that you host yourself (e.g.&nbsp;HuggingFace models)</li>
<li>To use an LM in DSPy, you first create an instance of the appropriate LM class (e.g.&nbsp;dspy.OpenAI for OpenAI models) and configure it as the default LM with dspy.configure</li>
<li>You can then call the LM directly with a raw prompt string, but the recommended way is to use DSPy modules and signatures which provide a more structured way to interact with the LM</li>
<li>DSPy’s key innovation is its ability to algorithmically optimize the prompts and weights of LMs, especially when used in multi-step pipelines This allows DSPy to significantly improve the reliability and performance of LMs on specific tasks compared to manual prompt engineering</li>
</ul>
<div id="cell-4" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> groq_lm <span class="im">import</span> LLAMA3_MODEL, GroqLM</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>gpt3_turbo <span class="op">=</span> dspy.OpenAI(model<span class="op">=</span><span class="st">"gpt-3.5-turbo-1106"</span>, max_tokens<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>gpt4_turbo <span class="op">=</span> dspy.OpenAI(model<span class="op">=</span><span class="st">"gpt-4-turbo"</span>, max_tokens<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>llama3 <span class="op">=</span> dspy.OllamaLocal(model<span class="op">=</span><span class="st">"llama3"</span>, max_tokens<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>groq_llama3 <span class="op">=</span> GroqLM(model<span class="op">=</span>LLAMA3_MODEL, max_tokens<span class="op">=</span><span class="dv">300</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Groq model used today: llama3-70b-8192</code></pre>
</div>
</div>
<div id="cell-5" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>gpt3_turbo(<span class="st">"hello! this is a raw prompt to GPT-3.5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>['Hello! How can I assist you today?']</code></pre>
</div>
</div>
<div id="cell-6" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>groq_llama3(<span class="st">"hello! this is a raw prompt to GroqLLAMA3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>["Hello! I'm GroqLLaMA3, nice to meet you! What's on your mind? Do you have a question, topic, or task you'd like to discuss or explore? I'm all ears (or rather, all text)!"]</code></pre>
</div>
</div>
<div id="cell-7" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dspy.configure(lm<span class="op">=</span>gpt3_turbo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-8" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>qa <span class="op">=</span> dspy.ChainOfThought(<span class="st">"question -&gt; answer"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> qa(question<span class="op">=</span><span class="st">"How many floors are in the castle David Gregory inherited?"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Prediction(
    rationale='produce the answer. We know that the castle has a total of 7 floors, including the basement and the attic.',
    answer='The castle David Gregory inherited has 7 floors.'
)</code></pre>
</div>
</div>
<div id="cell-9" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> dspy.context(lm<span class="op">=</span>gpt4_turbo):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> qa(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>            question<span class="op">=</span><span class="st">"How many floors are in the castle David Gregory inherited?"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>            config<span class="op">=</span><span class="bu">dict</span>(temperature<span class="op">=</span><span class="fl">0.7</span> <span class="op">+</span> <span class="fl">0.0001</span> <span class="op">*</span> idx),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>idx<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">."</span>, response)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>1. Prediction(
    rationale="determine the number of floors in the castle inherited by David Gregory. We need to analyze the provided information about the castle or typical castle structures if specific details are not given. Since the question does not specify details about the castle's size or style, we generally assume a typical castle might have at least 2 to 5 floors, including the main floors and possibly a basement or attic. However, without specific information about this particular castle, a precise answer cannot be given.",
    answer='The number of floors in the castle David Gregory inherited is not specified in the available information.'
)
2. Prediction(
    rationale='determine the number of floors in the castle David Gregory inherited. We need to check the provided information or context surrounding David Gregory and his castle. Since no specific information about the castle is provided in the question, we cannot ascertain the number of floors based on the given data alone. Typically, a castle might have several floors ranging from two to potentially five or more in grander structures, but without specific details or references, the exact number cannot be confirmed.',
    answer='The number of floors in the castle David Gregory inherited is not specified in the provided information.'
)
3. Prediction(
    rationale='determine the number of floors in the castle inherited by David Gregory. First, we would need information about the castle itself, which is not provided in the question. Without specific details about the castle or a source of information that mentions the number of floors in the castle, we cannot definitively answer the question.',
    answer='The number of floors in the castle David Gregory inherited is not specified in the provided information.'
)
4. Prediction(
    rationale="determine the number of floors in the castle inherited by David Gregory. Since the information about the number of floors in the castle is not provided in the given text or context, we can't directly know the answer. Usually, castles can vary greatly in size and number of floors, often having between two and five floors, including towers and possible underground levels. Without specific details about this particular castle, stating an exact number would be speculative.",
    answer='The number of floors in the castle David Gregory inherited is not specified in the provided information.'
)
5. Prediction(
    rationale="determine the number of floors in the castle inherited by David Gregory. First, if the number of floors in the castle was mentioned in a document, story, or data provided prior, we would refer to that. Since we don't have that document or story at hand, and there is no widely known information regarding a castle owned by David Gregory, we would need more specific information or context to accurately provide an answer.",
    answer='The number of floors in the castle David Gregory inherited cannot be determined with the information provided.'
)</code></pre>
</div>
</div>
<div id="cell-10" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> dspy.context(lm<span class="op">=</span>gpt4_turbo):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    qa <span class="op">=</span> dspy.ChainOfThought(<span class="st">"question -&gt; answer"</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> qa(question<span class="op">=</span><span class="st">"What did David Gregory inherit?"</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(response)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Prediction(
    rationale="Question: What did David Gregory inherit?\nReasoning: Let's think step by step in order to determine what David Gregory inherited. We need to consider the context or source of information about David Gregory, as there could be multiple individuals with that name. If we are referring to a specific story, book, or historical account, details from that source would guide us. Without specific context, we can't provide a precise answer, but we can hypothesize based on common scenarios involving inheritance.",
    answer='It is unclear what David Gregory inherited without additional context or information about which David Gregory is being referred to.'
)</code></pre>
</div>
</div>
</section>
<section id="signatures" class="level2">
<h2 class="anchored" data-anchor-id="signatures">Signatures</h2>
<section id="inline-signatures" class="level3">
<h3 class="anchored" data-anchor-id="inline-signatures">Inline Signatures</h3>
<div id="cell-13" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>sentence <span class="op">=</span> (</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"it's a charming and often affecting journey."</span>  <span class="co"># example from the SST-2 dataset.</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>classify <span class="op">=</span> dspy.Predict(<span class="st">"sentence -&gt; sentiment"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>classify(sentence<span class="op">=</span>sentence)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>Prediction(
    sentiment='Positive'
)</code></pre>
</div>
</div>
<div id="cell-14" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>document <span class="op">=</span> <span class="st">"""The 21-year-old made seven appearances for the Hammers and netted his only goal for them in a Europa League qualification round match against Andorran side FC Lustrains last season. Lee had two loan spells in League One last term, with Blackpool and then Colchester United. He scored twice for the U's but was unable to save them from relegation. The length of Lee's contract with the promoted Tykes has not been revealed. Find all the latest football transfers on our dedicated page."""</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>summarize <span class="op">=</span> dspy.ChainOfThought(<span class="st">"document -&gt; summary"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>summarize(document<span class="op">=</span>document)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>Prediction(
    rationale="produce the summary. We need to highlight the player's performance for West Ham, his loan spells in League One, and his new contract with Barnsley.",
    summary='The 21-year-old player made seven appearances and scored one goal for West Ham in the Europa League. He had loan spells in League One with Blackpool and Colchester United, scoring twice for the latter. He has now signed a contract with Barnsley, but the length of the contract has not been disclosed.'
)</code></pre>
</div>
</div>
</section>
<section id="class-based-signatures" class="level3">
<h3 class="anchored" data-anchor-id="class-based-signatures">Class-based Signatures</h3>
<div id="cell-16" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Emotion(dspy.Signature):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Classify emotion among sadness, joy, love, anger, fear, surprise."""</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    sentence <span class="op">=</span> dspy.InputField()</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    sentiment <span class="op">=</span> dspy.OutputField()</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>sentence <span class="op">=</span> <span class="st">"i started feeling a little vulnerable when the giant spotlight started blinding me"</span>  <span class="co"># from dair-ai/emotion</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>classify <span class="op">=</span> dspy.Predict(Emotion)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>classify(sentence<span class="op">=</span>sentence)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>Prediction(
    sentiment='Fear'
)</code></pre>
</div>
</div>
<div id="cell-17" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CheckCitationFaithfulness(dspy.Signature):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Verify that the text is based on the provided context."""</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"facts here are assumed to be true"</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> dspy.InputField()</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    faithfulness <span class="op">=</span> dspy.OutputField(</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">"True/False indicating if text is faithful to context"</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>context <span class="op">=</span> <span class="st">"The 21-year-old made seven appearances for the Hammers and netted his only goal for them in a Europa League qualification round match against Andorran side FC Lustrains last season. Lee had two loan spells in League One last term, with Blackpool and then Colchester United. He scored twice for the U's but was unable to save them from relegation. The length of Lee's contract with the promoted Tykes has not been revealed. Find all the latest football transfers on our dedicated page."</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"Lee scored 3 goals for Colchester United."</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>faithfulness <span class="op">=</span> dspy.ChainOfThought(CheckCitationFaithfulness)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>faithfulness(context<span class="op">=</span>context, text<span class="op">=</span>text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>Prediction(
    rationale="produce the faithfulness. We know that Lee had two loan spells in League One last term, with Blackpool and then Colchester United. He scored twice for the U's but was unable to save them from relegation. The text states that Lee scored 3 goals for Colchester United, which is not accurate based on the context.",
    faithfulness='False'
)</code></pre>
</div>
</div>
</section>
</section>
<section id="modules" class="level2">
<h2 class="anchored" data-anchor-id="modules">Modules</h2>
<section id="multiple-completions" class="level3">
<h3 class="anchored" data-anchor-id="multiple-completions">Multiple Completions</h3>
<div id="cell-20" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>question <span class="op">=</span> <span class="st">"What's something great about the ColBERT retrieval model?"</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Declare with a signature, and pass some config.</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>classify <span class="op">=</span> dspy.ChainOfThought(<span class="st">"question -&gt; answer"</span>, n<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Call with input argument.</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> classify(question<span class="op">=</span>question)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Access the outputs.</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">. </span><span class="sc">{</span>response<span class="sc">.</span>completions[i]<span class="sc">.</span>answer<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Rationale: </span><span class="sc">{</span>response<span class="sc">.</span>completions[i]<span class="sc">.</span>rationale<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>1. One great thing about the ColBERT retrieval model is its ability to efficiently retrieve relevant documents, improving search accuracy and speed.
   Rationale: produce the answer. We can consider the fact that the ColBERT retrieval model is designed to efficiently retrieve relevant documents for a given query, improving search accuracy and speed.
2. One great thing about the ColBERT retrieval model is its use of BERT and document-level embeddings, as well as its innovative pre-training objective that improves retrieval accuracy.
   Rationale: produce the answer. We can start by considering its use of BERT embeddings and document-level embeddings to improve retrieval accuracy. The ColBERT model also utilizes a novel pre-training objective that encourages learning from hard negatives, further enhancing its performance.
3. Its efficiency in retrieving and ranking passages from large-scale document collections.
   Rationale: produce the answer. We can start by considering the fact that ColBERT is designed to efficiently retrieve and rank passages from large-scale document collections. This means that it can quickly find relevant information, making it a powerful tool for information retrieval tasks.
4. One great aspect of the ColBERT retrieval model is its efficient handling of large-scale datasets and complex query structures.
   Rationale: produce the answer. We can consider its ability to handle large-scale datasets efficiently and effectively, its support for document relevance scoring, and its ability to handle complex query structures.
5. One great aspect of the ColBERT retrieval model is its improved efficiency and accuracy in information retrieval tasks.
   Rationale: produce the answer. We can consider the fact that the ColBERT retrieval model has been designed to improve efficiency and accuracy in information retrieval tasks. It uses efficient nearest neighbor search algorithms and has been shown to outperform other state-of-the-art models in retrieval tasks.</code></pre>
</div>
</div>
</section>
<section id="chain-of-thought-with-hint" class="level3">
<h3 class="anchored" data-anchor-id="chain-of-thought-with-hint">Chain of Thought with Hint</h3>
<div id="cell-22" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a simple signature for basic question answering</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BasicQA(dspy.Signature):</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Answer questions with short factoid answers."""</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    question <span class="op">=</span> dspy.InputField()</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    answer <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"often between 1 and 5 words"</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Pass signature to ChainOfThought module</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>generate_answer <span class="op">=</span> dspy.ChainOfThoughtWithHint(BasicQA)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Call the predictor on a particular input alongside a hint.</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>question <span class="op">=</span> <span class="st">"What is the color of the sky?"</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>hint <span class="op">=</span> <span class="st">"It's what you often see during a sunny day."</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> generate_answer(question<span class="op">=</span>question, hint<span class="op">=</span>hint)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Predicted Answer: </span><span class="sc">{</span>pred<span class="sc">.</span>answer<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Question: What is the color of the sky?
Predicted Answer: Blue</code></pre>
</div>
</div>
</section>
<section id="multi-chain-comparison" class="level3">
<h3 class="anchored" data-anchor-id="multi-chain-comparison">Multi-Chain Comparison</h3>
<div id="cell-24" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BasicQA(dspy.Signature):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Answer questions with short factoid answers."""</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    question <span class="op">=</span> dspy.InputField()</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    answer <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"often between 1 and 5 words"</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Example completions generated by a model for reference</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>completions <span class="op">=</span> [</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    dspy.Prediction(</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        rationale<span class="op">=</span><span class="st">"I recall that during clear days, the sky often appears this color."</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        answer<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    dspy.Prediction(</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        rationale<span class="op">=</span><span class="st">"Based on common knowledge, I believe the sky is typically seen as this color."</span>,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        answer<span class="op">=</span><span class="st">"green"</span>,</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    dspy.Prediction(</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        rationale<span class="op">=</span><span class="st">"From images and depictions in media, the sky is frequently represented with this hue."</span>,</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        answer<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Pass signature to MultiChainComparison module</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>compare_answers <span class="op">=</span> dspy.MultiChainComparison(BasicQA)</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Call the MultiChainComparison on the completions</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>question <span class="op">=</span> <span class="st">"What is the color of the sky?"</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>final_pred <span class="op">=</span> compare_answers(completions, question<span class="op">=</span>question)</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final Predicted Answer (after comparison): </span><span class="sc">{</span>final_pred<span class="sc">.</span>answer<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final Rationale: </span><span class="sc">{</span>final_pred<span class="sc">.</span>rationale<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Question: What is the color of the sky?
Final Predicted Answer (after comparison): Blue
Final Rationale: say that the color of the sky is blue.</code></pre>
</div>
</div>
</section>
<section id="program-of-thought" class="level3">
<h3 class="anchored" data-anchor-id="program-of-thought">Program of Thought</h3>
<div id="cell-26" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a simple signature for basic question answering</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GenerateAnswer(dspy.Signature):</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Answer questions with short factoid answers."""</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    question <span class="op">=</span> dspy.InputField()</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    answer <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"often between 1 and 5 words"</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Pass signature to ProgramOfThought Module</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>pot <span class="op">=</span> dspy.ProgramOfThought(GenerateAnswer)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Call the ProgramOfThought module on a particular input</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>question <span class="op">=</span> <span class="st">"Sarah has 5 apples. She buys 7 more apples from the store. How many apples does Sarah have now?"</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> pot(question<span class="op">=</span>question)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final Predicted Answer (after ProgramOfThought process): </span><span class="sc">{</span>result<span class="sc">.</span>answer<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Question: Sarah has 5 apples. She buys 7 more apples from the store. How many apples does Sarah have now?
Final Predicted Answer (after ProgramOfThought process): 12</code></pre>
</div>
</div>
</section>
<section id="react" class="level3">
<h3 class="anchored" data-anchor-id="react">ReAct</h3>
<div id="cell-28" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a simple signature for basic question answering</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BasicQA(dspy.Signature):</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Answer questions with short factoid answers."""</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    question <span class="op">=</span> dspy.InputField()</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    answer <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"often between 1 and 5 words"</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Pass signature to ReAct module</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>react_module <span class="op">=</span> dspy.ReAct(BasicQA)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Call the ReAct module on a particular input</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>question <span class="op">=</span> <span class="st">"What is the color of the sky?"</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> react_module(question<span class="op">=</span>question)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final Predicted Answer (after ReAct process): </span><span class="sc">{</span>result<span class="sc">.</span>answer<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Question: What is the color of the sky?
Final Predicted Answer (after ReAct process): The color of the sky is typically blue during the day and black at night.</code></pre>
</div>
</div>
</section>
<section id="retrieve" class="level3">
<h3 class="anchored" data-anchor-id="retrieve">Retrieve</h3>
<div id="cell-30" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>colbertv2_wiki17_abstracts <span class="op">=</span> dspy.ColBERTv2(</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    url<span class="op">=</span><span class="st">"http://20.102.90.50:2017/wiki17_abstracts"</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>retrieval_response <span class="op">=</span> colbertv2_wiki17_abstracts(</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"When was the first FIFA World Cup held?"</span>, k<span class="op">=</span><span class="dv">5</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> result <span class="kw">in</span> retrieval_response:</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Text:"</span>, result[<span class="st">"text"</span>], <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Text: History of the FIFA World Cup | The FIFA World Cup was first held in 1930, when FIFA president Jules Rimet decided to stage an international football tournament. The inaugural edition, held in 1930, was contested as a final tournament of only thirteen teams invited by the organization. Since then, the World Cup has experienced successive expansions and format remodeling to its current 32-team final tournament preceded by a two-year qualifying process, involving over 200 teams from around the world. 

Text: 1950 FIFA World Cup | The 1950 FIFA World Cup, held in Brazil from 24 June to 16 July 1950, was the fourth FIFA World Cup. It was the first World Cup since 1938, the planned 1942 and 1946 competitions having been cancelled owing to World War II. It was won by Uruguay, who had won the inaugural competition in 1930, clinching the cup by beating the hosts Brazil 2–1 in the deciding match of the four-team final group (this was the only tournament not decided by a one-match final). It was also the first tournament where the trophy was referred to as the Jules Rimet Cup, to mark the 25th anniversary of Jules Rimet's presidency of FIFA. 

Text: 1970 FIFA World Cup | The 1970 FIFA World Cup was the ninth FIFA World Cup, the quadrennial international football championship for men's national teams. Held from 31 May to 21 June in Mexico, it was the first World Cup tournament staged in North America, and the first held outside Europe and South America. Teams representing 75 nations from all six populated continents entered the competition, and its qualification rounds began in May 1968. Fourteen teams qualified from this process to join host nation Mexico and defending champions England in the sixteen-team final tournament. El Salvador, Israel, and Morocco made their first appearances at the final stage, and Peru their first since 1930. 

Text: 1974 FIFA World Cup | The 1974 FIFA World Cup, the tenth staging of the World Cup, was held in West Germany (including West Berlin) from 13 June to 7 July. The tournament marked the first time that the current trophy, the FIFA World Cup Trophy, created by the Italian sculptor Silvio Gazzaniga, was awarded. The previous trophy, the Jules Rimet Trophy, had been won for the third time by Brazil in 1970 and awarded permanently to the Brazilians. The host nation won the title beating the Netherlands in the final, 2–1. The victory was the second for West Germany, who had also won in 1954. Australia, East Germany, Haiti and Zaire made their first appearances at the final stage, and the Netherlands and Poland their first since 1938. 

Text: 1954 FIFA World Cup | The 1954 FIFA World Cup, the fifth staging of the FIFA World Cup, was held in Switzerland from 16 June to 4 July. Switzerland was chosen as hosts in July 1946. The tournament set a number of all-time records for goal-scoring, including the highest average goals scored per game. The tournament was won by West Germany, who defeated Hungary 3–2 in the final, giving them their first title. 
</code></pre>
</div>
</div>
<div id="cell-31" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>dspy.settings.configure(rm<span class="op">=</span>colbertv2_wiki17_abstracts)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"When was the first FIFA World Cup held?"</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Call the retriever on a particular query.</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>retrieve <span class="op">=</span> dspy.Retrieve(k<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>topK_passages <span class="op">=</span> retrieve(query).passages</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Top </span><span class="sc">{</span>retrieve<span class="sc">.</span>k<span class="sc">}</span><span class="ss"> passages for question: </span><span class="sc">{</span>query<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">"</span>, <span class="st">"-"</span> <span class="op">*</span> <span class="dv">30</span>, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, passage <span class="kw">in</span> <span class="bu">enumerate</span>(topK_passages):</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>idx<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">]"</span>, passage, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Top 3 passages for question: When was the first FIFA World Cup held? 
 ------------------------------ 

1] History of the FIFA World Cup | The FIFA World Cup was first held in 1930, when FIFA president Jules Rimet decided to stage an international football tournament. The inaugural edition, held in 1930, was contested as a final tournament of only thirteen teams invited by the organization. Since then, the World Cup has experienced successive expansions and format remodeling to its current 32-team final tournament preceded by a two-year qualifying process, involving over 200 teams from around the world. 

2] 1950 FIFA World Cup | The 1950 FIFA World Cup, held in Brazil from 24 June to 16 July 1950, was the fourth FIFA World Cup. It was the first World Cup since 1938, the planned 1942 and 1946 competitions having been cancelled owing to World War II. It was won by Uruguay, who had won the inaugural competition in 1930, clinching the cup by beating the hosts Brazil 2–1 in the deciding match of the four-team final group (this was the only tournament not decided by a one-match final). It was also the first tournament where the trophy was referred to as the Jules Rimet Cup, to mark the 25th anniversary of Jules Rimet's presidency of FIFA. 

3] 1970 FIFA World Cup | The 1970 FIFA World Cup was the ninth FIFA World Cup, the quadrennial international football championship for men's national teams. Held from 31 May to 21 June in Mexico, it was the first World Cup tournament staged in North America, and the first held outside Europe and South America. Teams representing 75 nations from all six populated continents entered the competition, and its qualification rounds began in May 1968. Fourteen teams qualified from this process to join host nation Mexico and defending champions England in the sixteen-team final tournament. El Salvador, Israel, and Morocco made their first appearances at the final stage, and Peru their first since 1930. 
</code></pre>
</div>
</div>
</section>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<section id="example-objects" class="level3">
<h3 class="anchored" data-anchor-id="example-objects">Example Objects</h3>
<div id="cell-34" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>qa_pair <span class="op">=</span> dspy.Example(question<span class="op">=</span><span class="st">"This is a question?"</span>, answer<span class="op">=</span><span class="st">"This is an answer."</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(qa_pair)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(qa_pair.question)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(qa_pair.answer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Example({'question': 'This is a question?', 'answer': 'This is an answer.'}) (input_keys=None)
This is a question?
This is an answer.</code></pre>
</div>
</div>
</section>
<section id="input-keys" class="level3">
<h3 class="anchored" data-anchor-id="input-keys">Input Keys</h3>
<p>In a typical machine learning dataset (comprising training, testing, and validation sets), there are distinct “inputs” and “labels”. In DSPy, the Example objects offer a <code>with_inputs()</code> method, allowing certain fields to be designated as inputs while the remaining fields serve as metadata or labels.</p>
<div id="cell-36" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Single Input.</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>qa_pair <span class="op">=</span> qa_pair.with_inputs(<span class="st">"question"</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(qa_pair.inputs())</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(qa_pair.labels())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Example({'question': 'This is a question?'}) (input_keys=None)
Example({'answer': 'This is an answer.'}) (input_keys=None)</code></pre>
</div>
</div>
</section>
</section>
<section id="metrics" class="level2">
<h2 class="anchored" data-anchor-id="metrics">Metrics</h2>
<p>DSPy is a machine learning framework that requires thoughtful consideration of automatic metrics for evaluating and optimizing programs. A metric is a function that assesses the quality of program output. Simple tasks might use metrics like accuracy or F1 score, while complex tasks may require more detailed metrics, possibly involving AI feedback from language models. It’s important to start with a simple metric and iterate to improve it.</p>
<section id="simple-metrics" class="level3">
<h3 class="anchored" data-anchor-id="simple-metrics">Simple Metrics</h3>
<p>A DSPy metric is a Python function that compares example and pred outputs, returning a numerical score. It can also accept a trace argument for optimization purposes.</p>
<div id="cell-39" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_answer(example, pred, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> example.answer.lower() <span class="op">==</span> pred.answer.lower()</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>validate_answer(qa_pair, qa_pair)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>True</code></pre>
</div>
</div>
<div id="cell-40" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy <span class="im">import</span> evaluate</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>evaluate.metrics.answer_exact_match(qa_pair, qa_pair)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>True</code></pre>
</div>
</div>
<div id="cell-41" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>qa_ctx <span class="op">=</span> dspy.Example(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    question<span class="op">=</span><span class="st">"This is a question?"</span>,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    answer<span class="op">=</span><span class="st">"This is an answer."</span>,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    context<span class="op">=</span>[<span class="st">"This is an answer."</span>],</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>evaluate.metrics.answer_passage_match(qa_pair, qa_ctx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>True</code></pre>
</div>
</div>
</section>
</section>
<section id="rag-tutorial" class="level2">
<h2 class="anchored" data-anchor-id="rag-tutorial">RAG Tutorial</h2>
<section id="configure-lm-and-rm" class="level3">
<h3 class="anchored" data-anchor-id="configure-lm-and-rm">Configure LM and RM</h3>
<div id="cell-44" class="cell" data-execution_count="29">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>turbo <span class="op">=</span> dspy.OpenAI(model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>colbertv2_wiki17_abstracts <span class="op">=</span> dspy.ColBERTv2(</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    url<span class="op">=</span><span class="st">"http://20.102.90.50:2017/wiki17_abstracts"</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>dspy.settings.configure(lm<span class="op">=</span>turbo, rm<span class="op">=</span>colbertv2_wiki17_abstracts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="load-the-dataset" class="level3">
<h3 class="anchored" data-anchor-id="load-the-dataset">Load the Dataset</h3>
<div id="cell-46" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.datasets <span class="im">import</span> HotPotQA</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dataset.</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> HotPotQA(</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    train_seed<span class="op">=</span><span class="dv">1</span>, train_size<span class="op">=</span><span class="dv">20</span>, eval_seed<span class="op">=</span><span class="dv">2023</span>, dev_size<span class="op">=</span><span class="dv">50</span>, test_size<span class="op">=</span><span class="dv">0</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Tell DSPy that the 'question' field is the input. Any other fields are labels and/or metadata.</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>trainset <span class="op">=</span> [x.with_inputs(<span class="st">"question"</span>) <span class="cf">for</span> x <span class="kw">in</span> dataset.train]</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>devset <span class="op">=</span> [x.with_inputs(<span class="st">"question"</span>) <span class="cf">for</span> x <span class="kw">in</span> dataset.dev]</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(trainset), <span class="bu">len</span>(devset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/dothomps/.pyenv/versions/3.11.9/envs/blog/lib/python3.11/site-packages/datasets/table.py:1421: FutureWarning: promote has been superseded by promote_options='default'.
  table = cls._concat_blocks(blocks, axis=0)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>(20, 50)</code></pre>
</div>
</div>
</section>
<section id="build-the-signature" class="level3">
<h3 class="anchored" data-anchor-id="build-the-signature">Build the Signature</h3>
<div id="cell-48" class="cell" data-execution_count="31">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GenerateAnswer(dspy.Signature):</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Answer questions with short factoid answers."""</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"may contain relevant facts"</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    question <span class="op">=</span> dspy.InputField()</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    answer <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"often between 1 and 5 words"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="build-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="build-the-pipeline">Build the Pipeline</h3>
<div id="cell-50" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RAG(dspy.Module):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_passages<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.retrieve <span class="op">=</span> dspy.Retrieve(k<span class="op">=</span>num_passages)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.generate_answer <span class="op">=</span> dspy.ChainOfThought(GenerateAnswer)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, question):</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>        context <span class="op">=</span> <span class="va">self</span>.retrieve(question).passages</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>        prediction <span class="op">=</span> <span class="va">self</span>.generate_answer(context<span class="op">=</span>context, question<span class="op">=</span>question)</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dspy.Prediction(context<span class="op">=</span>context, answer<span class="op">=</span>prediction.answer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="optimize-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="optimize-the-pipeline">Optimize the Pipeline</h3>
<div id="cell-52" class="cell" data-execution_count="33">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.teleprompt <span class="im">import</span> BootstrapFewShot</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Validation logic: check that the predicted answer is correct.</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Also check that the retrieved context does actually contain that answer.</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_context_and_answer(example, pred, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    answer_EM <span class="op">=</span> dspy.evaluate.answer_exact_match(example, pred)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    answer_PM <span class="op">=</span> dspy.evaluate.answer_passage_match(example, pred)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> answer_EM <span class="kw">and</span> answer_PM</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up a basic teleprompter, which will compile our RAG program.</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>teleprompter <span class="op">=</span> BootstrapFewShot(metric<span class="op">=</span>validate_context_and_answer)</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile!</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>compiled_rag <span class="op">=</span> teleprompter.<span class="bu">compile</span>(RAG(), trainset<span class="op">=</span>trainset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code> 55%|█████▌    | 11/20 [00:00&lt;00:00, 62.21it/s]</code></pre>
</div>
</div>
</section>
<section id="execute-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="execute-the-pipeline">Execute the Pipeline</h3>
<div id="cell-54" class="cell" data-execution_count="34">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ask any question you like to this simple RAG program.</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>my_question <span class="op">=</span> <span class="st">"What castle did David Gregory inherit?"</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the prediction. This contains `pred.context` and `pred.answer`.</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> compiled_rag(my_question)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the contexts and the answer.</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>my_question<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Predicted Answer: </span><span class="sc">{</span>pred<span class="sc">.</span>answer<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Retrieved Contexts (truncated): </span><span class="sc">{</span>[c[:<span class="dv">200</span>] <span class="op">+</span> <span class="st">'...'</span> <span class="cf">for</span> c <span class="kw">in</span> pred.context]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Question: What castle did David Gregory inherit?
Predicted Answer: Kinnairdy Castle
Retrieved Contexts (truncated): ['David Gregory (physician) | David Gregory (20 December 1625 – 1720) was a Scottish physician and inventor. His surname is sometimes spelt as Gregorie, the original Scottish spelling. He inherited Kinn...', 'Gregory Tarchaneiotes | Gregory Tarchaneiotes (Greek: Γρηγόριος Ταρχανειώτης , Italian: "Gregorio Tracanioto" or "Tracamoto" ) was a "protospatharius" and the long-reigning catepan of Italy from 998 t...', 'David Gregory (mathematician) | David Gregory (originally spelt Gregorie) FRS (? 1659 – 10 October 1708) was a Scottish mathematician and astronomer. He was professor of mathematics at the University ...']</code></pre>
</div>
</div>
<div id="cell-55" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>turbo.inspect_history(n<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>


Answer questions with short factoid answers.

---

Question: At My Window was released by which American singer-songwriter?
Answer: John Townes Van Zandt

Question: "Everything Has Changed" is a song from an album released under which record label ?
Answer: Big Machine Records

Question: The Victorians - Their Story In Pictures is a documentary series written by an author born in what year?
Answer: 1950

Question: Which Pakistani cricket umpire who won 3 consecutive ICC umpire of the year awards in 2009, 2010, and 2011 will be in the ICC World Twenty20?
Answer: Aleem Sarwar Dar

Question: Having the combination of excellent foot speed and bat speed helped Eric Davis, create what kind of outfield for the Los Angeles Dodgers?
Answer: "Outfield of Dreams"

Question: Who is older, Aleksandr Danilovich Aleksandrov or Anatoly Fomenko?
Answer: Aleksandr Danilovich Aleksandrov

Question: The Organisation that allows a community to influence their operation or use and to enjoy the benefits arisingwas founded in what year?
Answer: 2010

Question: Tombstone stared an actor born May 17, 1955 known as who?
Answer: Bill Paxton

Question: In what year was the club founded that played Manchester City in the 1972 FA Charity Shield
Answer: 1874

Question: which American actor was Candace Kita guest starred with
Answer: Bill Murray

Question: Which is taller, the Empire State Building or the Bank of America Tower?
Answer: The Empire State Building

Question: Which company distributed this 1977 American animated film produced by Walt Disney Productions for which Sherman Brothers wrote songs?
Answer: Buena Vista Distribution

---

Follow the following format.

Context: may contain relevant facts

Question: ${question}

Reasoning: Let's think step by step in order to ${produce the answer}. We ...

Answer: often between 1 and 5 words

---

Context:
[1] «Tae Kwon Do Times | Tae Kwon Do Times is a magazine devoted to the martial art of taekwondo, and is published in the United States of America. While the title suggests that it focuses on taekwondo exclusively, the magazine also covers other Korean martial arts. "Tae Kwon Do Times" has published articles by a wide range of authors, including He-Young Kimm, Thomas Kurz, Scott Shaw, and Mark Van Schuyver.»
[2] «Kwon Tae-man | Kwon Tae-man (born 1941) was an early Korean hapkido practitioner and a pioneer of the art, first in Korea and then in the United States. He formed one of the earliest dojang's for hapkido in the United States in Torrance, California, and has been featured in many magazine articles promoting the art.»
[3] «Hee Il Cho | Cho Hee Il (born October 13, 1940) is a prominent Korean-American master of taekwondo, holding the rank of 9th "dan" in the martial art. He has written 11 martial art books, produced 70 martial art training videos, and has appeared on more than 70 martial arts magazine covers. Cho won several national and international competitions as a taekwondo competitor, and has appeared in several films, including "Fight to Win", "Best of the Best", "Bloodsport II", and "Bloodsport III". He founded the Action International Martial Arts Association (AIMAA) in 1980, and is its President. Cho is a member of both "Black Belt" magazine's Hall of Fame and "Tae Kwon Do Times" magazine's Hall of Fame.»

Question: Which magazine has published articles by Scott Shaw, Tae Kwon Do Times or Southwest Art?

Reasoning: Let's think step by step in order to produce the answer. We know that "Tae Kwon Do Times" has published articles by Scott Shaw, as mentioned in the context.

Answer: Tae Kwon Do Times

---

Context:
[1] «Rosario Dawson | Rosario Isabel Dawson (born May 9, 1979) is an American actress, producer, singer, comic book writer, and political activist. She made her film debut in the 1995 teen drama "Kids". Her subsequent film roles include "He Got Game", "Men in Black II", "25th Hour", "Rent", "Sin City", "Death Proof", "Seven Pounds", "", and "Top Five". Dawson has also provided voice-over work for Disney and DC.»
[2] «Sarai Gonzalez | Sarai Isaura Gonzalez (born 2005) is an American Latina child actress who made her professional debut at the age of 11 on the Spanish-language ""Soy Yo"" ("That's Me") music video by Bomba Estéreo. Cast as a "nerdy" tween with a "sassy" and "confident" attitude, her performance turned her into a "Latina icon" for "female empowerment, identity and self-worth". She subsequently appeared in two get out the vote videos for Latinos in advance of the 2016 United States elections.»
[3] «Gabriela (2001 film) | Gabriela is a 2001 American romance film, starring Seidy Lopez in the title role alongside Jaime Gomez as her admirer Mike. The film has been cited as an inspiration behind the Premiere Weekend Club, which supports Latino film-making.»

Question: Which American actress who made their film debut in the 1995 teen drama "Kids" was the co-founder of Voto Latino?

Reasoning: Let's think step by step in order to produce the answer. We know that the actress who made her film debut in "Kids" is Rosario Dawson, and she is also known for her political activism and involvement in Voto Latino.

Answer: Rosario Dawson

---

Context:
[1] «Battle of Kursk | The Battle of Kursk was a Second World War engagement between German and Soviet forces on the Eastern Front near Kursk (450 km south-west of Moscow) in the Soviet Union during July and August 1943. The battle began with the launch of the German offensive, Operation Citadel (German: "Unternehmen Zitadelle" ), on 5 July, which had the objective of pinching off the Kursk salient with attacks on the base of the salient from north and south simultaneously. After the German offensive stalled on the northern side of the salient, on 12 July the Soviets commenced their Kursk Strategic Offensive Operation with the launch of Operation Kutuzov (Russian: Кутузов ) against the rear of the German forces in the northern side. On the southern side, the Soviets also launched powerful counterattacks the same day, one of which led to a large armoured clash, the Battle of Prokhorovka. On 3 August, the Soviets began the second phase of the Kursk Strategic Offensive Operation with the launch of Operation Polkovodets Rumyantsev (Russian: Полководец Румянцев ) against the German forces in the southern side of the Kursk salient.»
[2] «Operation Mars | Operation Mars, also known as the Second Rzhev-Sychevka Offensive Operation (Russian: Вторая Ржевско-Сычёвская наступательная операция), was the codename for an offensive launched by Soviet forces against German forces during World War II. It took place between 25 November and 20 December 1942 around the Rzhev salient in the vicinity of Moscow.»
[3] «Kholm Pocket | The Kholm Pocket (German: "Kessel von Cholm" ; Russian: Холмский котёл ) was the name given for the encirclement of German troops by the Red Army around Kholm south of Leningrad, during World War II on the Eastern Front, from 23 January 1942 until 5 May 1942. A much larger pocket was simultaneously surrounded in Demyansk, about 100 km to the northeast. These were the results of German retreat following their defeat during the Battle of Moscow.»

Question: What is the code name for the German offensive that started this Second World War engagement on the Eastern Front (a few hundred kilometers from Moscow) between Soviet and German forces, which included 102nd Infantry Division?

Reasoning: Let's think step by step in order to produce the answer. We know that the German offensive that started the Battle of Kursk was called Operation Citadel.

Answer: Operation Citadel

---

Context:
[1] «Kerry Condon | Kerry Condon (born 4 January 1983) is an Irish television and film actress, best known for her role as Octavia of the Julii in the HBO/BBC series "Rome," as Stacey Ehrmantraut in AMC's "Better Call Saul" and as the voice of F.R.I.D.A.Y. in various films in the Marvel Cinematic Universe. She is also the youngest actress ever to play Ophelia in a Royal Shakespeare Company production of "Hamlet."»
[2] «Corona Riccardo | Corona Riccardo (c. 1878October 15, 1917) was an Italian born American actress who had a brief Broadway stage career before leaving to become a wife and mother. Born in Naples she came to acting in 1894 playing a Mexican girl in a play at the Empire Theatre. Wilson Barrett engaged her for a role in his play "The Sign of the Cross" which he took on tour of the United States. Riccardo played the role of Ancaria and later played Berenice in the same play. Robert B. Mantell in 1898 who struck by her beauty also cast her in two Shakespeare plays, "Romeo and Juliet" and "Othello". Author Lewis Strang writing in 1899 said Riccardo was the most promising actress in America at the time. Towards the end of 1898 Mantell chose her for another Shakespeare part, Ophelia im Hamlet. Afterwards she was due to join Augustin Daly's Theatre Company but Daly died in 1899. In 1899 she gained her biggest fame by playing Iras in the first stage production of Ben-Hur.»
[3] «Judi Dench | Dame Judith Olivia "Judi" Dench, {'1': ", '2': ", '3': ", '4': "} (born 9 December 1934) is an English actress and author. Dench made her professional debut in 1957 with the Old Vic Company. Over the following few years, she performed in several of Shakespeare's plays in such roles as Ophelia in "Hamlet", Juliet in "Romeo and Juliet", and Lady Macbeth in "Macbeth". Although most of her work during this period was in theatre, she also branched into film work and won a BAFTA Award as Most Promising Newcomer. She drew strong reviews for her leading role in the musical "Cabaret" in 1968.»

Question: Who acted in the shot film The Shore and is also the youngest actress ever to play Ophelia in a Royal Shakespeare Company production of "Hamlet." ?

Reasoning: Let's think step by step in order to produce the answer. We know that the actress who played Ophelia in a Royal Shakespeare Company production of "Hamlet" is Kerry Condon.

Answer: Kerry Condon

---

Context:
[1] «David Gregory (physician) | David Gregory (20 December 1625 – 1720) was a Scottish physician and inventor. His surname is sometimes spelt as Gregorie, the original Scottish spelling. He inherited Kinnairdy Castle in 1664. Three of his twenty-nine children became mathematics professors. He is credited with inventing a military cannon that Isaac Newton described as "being destructive to the human species". Copies and details of the model no longer exist. Gregory's use of a barometer to predict farming-related weather conditions led him to be accused of witchcraft by Presbyterian ministers from Aberdeen, although he was never convicted.»
[2] «Gregory Tarchaneiotes | Gregory Tarchaneiotes (Greek: Γρηγόριος Ταρχανειώτης , Italian: "Gregorio Tracanioto" or "Tracamoto" ) was a "protospatharius" and the long-reigning catepan of Italy from 998 to 1006. In December 999, and again on February 2, 1002, he reinstituted and confirmed the possessions of the abbey and monks of Monte Cassino in Ascoli. In 1004, he fortified and expanded the castle of Dragonara on the Fortore. He gave it three circular towers and one square one. He also strengthened Lucera.»
[3] «David Gregory (mathematician) | David Gregory (originally spelt Gregorie) FRS (? 1659 – 10 October 1708) was a Scottish mathematician and astronomer. He was professor of mathematics at the University of Edinburgh, Savilian Professor of Astronomy at the University of Oxford, and a commentator on Isaac Newton's "Principia".»

Question: What castle did David Gregory inherit?

Reasoning: Let's think step by step in order to produce the answer. We know that David Gregory inherited Kinnairdy Castle.

Answer: Kinnairdy Castle


</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>'\n\n\nAnswer questions with short factoid answers.\n\n---\n\nQuestion: At My Window was released by which American singer-songwriter?\nAnswer: John Townes Van Zandt\n\nQuestion: "Everything Has Changed" is a song from an album released under which record label ?\nAnswer: Big Machine Records\n\nQuestion: The Victorians - Their Story In Pictures is a documentary series written by an author born in what year?\nAnswer: 1950\n\nQuestion: Which Pakistani cricket umpire who won 3 consecutive ICC umpire of the year awards in 2009, 2010, and 2011 will be in the ICC World Twenty20?\nAnswer: Aleem Sarwar Dar\n\nQuestion: Having the combination of excellent foot speed and bat speed helped Eric Davis, create what kind of outfield for the Los Angeles Dodgers?\nAnswer: "Outfield of Dreams"\n\nQuestion: Who is older, Aleksandr Danilovich Aleksandrov or Anatoly Fomenko?\nAnswer: Aleksandr Danilovich Aleksandrov\n\nQuestion: The Organisation that allows a community to influence their operation or use and to enjoy the benefits arisingwas founded in what year?\nAnswer: 2010\n\nQuestion: Tombstone stared an actor born May 17, 1955 known as who?\nAnswer: Bill Paxton\n\nQuestion: In what year was the club founded that played Manchester City in the 1972 FA Charity Shield\nAnswer: 1874\n\nQuestion: which American actor was Candace Kita guest starred with\nAnswer: Bill Murray\n\nQuestion: Which is taller, the Empire State Building or the Bank of America Tower?\nAnswer: The Empire State Building\n\nQuestion: Which company distributed this 1977 American animated film produced by Walt Disney Productions for which Sherman Brothers wrote songs?\nAnswer: Buena Vista Distribution\n\n---\n\nFollow the following format.\n\nContext: may contain relevant facts\n\nQuestion: ${question}\n\nReasoning: Let\'s think step by step in order to ${produce the answer}. We ...\n\nAnswer: often between 1 and 5 words\n\n---\n\nContext:\n[1] «Tae Kwon Do Times | Tae Kwon Do Times is a magazine devoted to the martial art of taekwondo, and is published in the United States of America. While the title suggests that it focuses on taekwondo exclusively, the magazine also covers other Korean martial arts. "Tae Kwon Do Times" has published articles by a wide range of authors, including He-Young Kimm, Thomas Kurz, Scott Shaw, and Mark Van Schuyver.»\n[2] «Kwon Tae-man | Kwon Tae-man (born 1941) was an early Korean hapkido practitioner and a pioneer of the art, first in Korea and then in the United States. He formed one of the earliest dojang\'s for hapkido in the United States in Torrance, California, and has been featured in many magazine articles promoting the art.»\n[3] «Hee Il Cho | Cho Hee Il (born October 13, 1940) is a prominent Korean-American master of taekwondo, holding the rank of 9th "dan" in the martial art. He has written 11 martial art books, produced 70 martial art training videos, and has appeared on more than 70 martial arts magazine covers. Cho won several national and international competitions as a taekwondo competitor, and has appeared in several films, including "Fight to Win", "Best of the Best", "Bloodsport II", and "Bloodsport III". He founded the Action International Martial Arts Association (AIMAA) in 1980, and is its President. Cho is a member of both "Black Belt" magazine\'s Hall of Fame and "Tae Kwon Do Times" magazine\'s Hall of Fame.»\n\nQuestion: Which magazine has published articles by Scott Shaw, Tae Kwon Do Times or Southwest Art?\n\nReasoning: Let\'s think step by step in order to produce the answer. We know that "Tae Kwon Do Times" has published articles by Scott Shaw, as mentioned in the context.\n\nAnswer: Tae Kwon Do Times\n\n---\n\nContext:\n[1] «Rosario Dawson | Rosario Isabel Dawson (born May 9, 1979) is an American actress, producer, singer, comic book writer, and political activist. She made her film debut in the 1995 teen drama "Kids". Her subsequent film roles include "He Got Game", "Men in Black II", "25th Hour", "Rent", "Sin City", "Death Proof", "Seven Pounds", "", and "Top Five". Dawson has also provided voice-over work for Disney and DC.»\n[2] «Sarai Gonzalez | Sarai Isaura Gonzalez (born 2005) is an American Latina child actress who made her professional debut at the age of 11 on the Spanish-language ""Soy Yo"" ("That\'s Me") music video by Bomba Estéreo. Cast as a "nerdy" tween with a "sassy" and "confident" attitude, her performance turned her into a "Latina icon" for "female empowerment, identity and self-worth". She subsequently appeared in two get out the vote videos for Latinos in advance of the 2016 United States elections.»\n[3] «Gabriela (2001 film) | Gabriela is a 2001 American romance film, starring Seidy Lopez in the title role alongside Jaime Gomez as her admirer Mike. The film has been cited as an inspiration behind the Premiere Weekend Club, which supports Latino film-making.»\n\nQuestion: Which American actress who made their film debut in the 1995 teen drama "Kids" was the co-founder of Voto Latino?\n\nReasoning: Let\'s think step by step in order to produce the answer. We know that the actress who made her film debut in "Kids" is Rosario Dawson, and she is also known for her political activism and involvement in Voto Latino.\n\nAnswer: Rosario Dawson\n\n---\n\nContext:\n[1] «Battle of Kursk | The Battle of Kursk was a Second World War engagement between German and Soviet forces on the Eastern Front near Kursk (450 km south-west of Moscow) in the Soviet Union during July and August 1943. The battle began with the launch of the German offensive, Operation Citadel (German: "Unternehmen Zitadelle" ), on 5 July, which had the objective of pinching off the Kursk salient with attacks on the base of the salient from north and south simultaneously. After the German offensive stalled on the northern side of the salient, on 12 July the Soviets commenced their Kursk Strategic Offensive Operation with the launch of Operation Kutuzov (Russian: Кутузов ) against the rear of the German forces in the northern side. On the southern side, the Soviets also launched powerful counterattacks the same day, one of which led to a large armoured clash, the Battle of Prokhorovka. On 3 August, the Soviets began the second phase of the Kursk Strategic Offensive Operation with the launch of Operation Polkovodets Rumyantsev (Russian: Полководец Румянцев ) against the German forces in the southern side of the Kursk salient.»\n[2] «Operation Mars | Operation Mars, also known as the Second Rzhev-Sychevka Offensive Operation (Russian: Вторая Ржевско-Сычёвская наступательная операция), was the codename for an offensive launched by Soviet forces against German forces during World War II. It took place between 25 November and 20 December 1942 around the Rzhev salient in the vicinity of Moscow.»\n[3] «Kholm Pocket | The Kholm Pocket (German: "Kessel von Cholm" ; Russian: Холмский котёл ) was the name given for the encirclement of German troops by the Red Army around Kholm south of Leningrad, during World War II on the Eastern Front, from 23 January 1942 until 5 May 1942. A much larger pocket was simultaneously surrounded in Demyansk, about 100 km to the northeast. These were the results of German retreat following their defeat during the Battle of Moscow.»\n\nQuestion: What is the code name for the German offensive that started this Second World War engagement on the Eastern Front (a few hundred kilometers from Moscow) between Soviet and German forces, which included 102nd Infantry Division?\n\nReasoning: Let\'s think step by step in order to produce the answer. We know that the German offensive that started the Battle of Kursk was called Operation Citadel.\n\nAnswer: Operation Citadel\n\n---\n\nContext:\n[1] «Kerry Condon | Kerry Condon (born 4 January 1983) is an Irish television and film actress, best known for her role as Octavia of the Julii in the HBO/BBC series "Rome," as Stacey Ehrmantraut in AMC\'s "Better Call Saul" and as the voice of F.R.I.D.A.Y. in various films in the Marvel Cinematic Universe. She is also the youngest actress ever to play Ophelia in a Royal Shakespeare Company production of "Hamlet."»\n[2] «Corona Riccardo | Corona Riccardo (c. 1878October 15, 1917) was an Italian born American actress who had a brief Broadway stage career before leaving to become a wife and mother. Born in Naples she came to acting in 1894 playing a Mexican girl in a play at the Empire Theatre. Wilson Barrett engaged her for a role in his play "The Sign of the Cross" which he took on tour of the United States. Riccardo played the role of Ancaria and later played Berenice in the same play. Robert B. Mantell in 1898 who struck by her beauty also cast her in two Shakespeare plays, "Romeo and Juliet" and "Othello". Author Lewis Strang writing in 1899 said Riccardo was the most promising actress in America at the time. Towards the end of 1898 Mantell chose her for another Shakespeare part, Ophelia im Hamlet. Afterwards she was due to join Augustin Daly\'s Theatre Company but Daly died in 1899. In 1899 she gained her biggest fame by playing Iras in the first stage production of Ben-Hur.»\n[3] «Judi Dench | Dame Judith Olivia "Judi" Dench, {\'1\': ", \'2\': ", \'3\': ", \'4\': "} (born 9 December 1934) is an English actress and author. Dench made her professional debut in 1957 with the Old Vic Company. Over the following few years, she performed in several of Shakespeare\'s plays in such roles as Ophelia in "Hamlet", Juliet in "Romeo and Juliet", and Lady Macbeth in "Macbeth". Although most of her work during this period was in theatre, she also branched into film work and won a BAFTA Award as Most Promising Newcomer. She drew strong reviews for her leading role in the musical "Cabaret" in 1968.»\n\nQuestion: Who acted in the shot film The Shore and is also the youngest actress ever to play Ophelia in a Royal Shakespeare Company production of "Hamlet." ?\n\nReasoning: Let\'s think step by step in order to produce the answer. We know that the actress who played Ophelia in a Royal Shakespeare Company production of "Hamlet" is Kerry Condon.\n\nAnswer: Kerry Condon\n\n---\n\nContext:\n[1] «David Gregory (physician) | David Gregory (20 December 1625 – 1720) was a Scottish physician and inventor. His surname is sometimes spelt as Gregorie, the original Scottish spelling. He inherited Kinnairdy Castle in 1664. Three of his twenty-nine children became mathematics professors. He is credited with inventing a military cannon that Isaac Newton described as "being destructive to the human species". Copies and details of the model no longer exist. Gregory\'s use of a barometer to predict farming-related weather conditions led him to be accused of witchcraft by Presbyterian ministers from Aberdeen, although he was never convicted.»\n[2] «Gregory Tarchaneiotes | Gregory Tarchaneiotes (Greek: Γρηγόριος Ταρχανειώτης , Italian: "Gregorio Tracanioto" or "Tracamoto" ) was a "protospatharius" and the long-reigning catepan of Italy from 998 to 1006. In December 999, and again on February 2, 1002, he reinstituted and confirmed the possessions of the abbey and monks of Monte Cassino in Ascoli. In 1004, he fortified and expanded the castle of Dragonara on the Fortore. He gave it three circular towers and one square one. He also strengthened Lucera.»\n[3] «David Gregory (mathematician) | David Gregory (originally spelt Gregorie) FRS (? 1659 – 10 October 1708) was a Scottish mathematician and astronomer. He was professor of mathematics at the University of Edinburgh, Savilian Professor of Astronomy at the University of Oxford, and a commentator on Isaac Newton\'s "Principia".»\n\nQuestion: What castle did David Gregory inherit?\n\nReasoning: Let\'s think step by step in order to\x1b[32m produce the answer. We know that David Gregory inherited Kinnairdy Castle.\n\nAnswer: Kinnairdy Castle\x1b[0m\n\n\n'</code></pre>
</div>
</div>
<div id="cell-56" class="cell" data-execution_count="36">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, parameter <span class="kw">in</span> compiled_rag.named_predictors():</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(name)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(parameter.demos[<span class="dv">0</span>])</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>generate_answer
Example({'augmented': True, 'context': ['Tae Kwon Do Times | Tae Kwon Do Times is a magazine devoted to the martial art of taekwondo, and is published in the United States of America. While the title suggests that it focuses on taekwondo exclusively, the magazine also covers other Korean martial arts. "Tae Kwon Do Times" has published articles by a wide range of authors, including He-Young Kimm, Thomas Kurz, Scott Shaw, and Mark Van Schuyver.', "Kwon Tae-man | Kwon Tae-man (born 1941) was an early Korean hapkido practitioner and a pioneer of the art, first in Korea and then in the United States. He formed one of the earliest dojang's for hapkido in the United States in Torrance, California, and has been featured in many magazine articles promoting the art.", 'Hee Il Cho | Cho Hee Il (born October 13, 1940) is a prominent Korean-American master of taekwondo, holding the rank of 9th "dan" in the martial art. He has written 11 martial art books, produced 70 martial art training videos, and has appeared on more than 70 martial arts magazine covers. Cho won several national and international competitions as a taekwondo competitor, and has appeared in several films, including "Fight to Win", "Best of the Best", "Bloodsport II", and "Bloodsport III". He founded the Action International Martial Arts Association (AIMAA) in 1980, and is its President. Cho is a member of both "Black Belt" magazine\'s Hall of Fame and "Tae Kwon Do Times" magazine\'s Hall of Fame.'], 'question': 'Which magazine has published articles by Scott Shaw, Tae Kwon Do Times or Southwest Art?', 'rationale': 'produce the answer. We know that "Tae Kwon Do Times" has published articles by Scott Shaw, as mentioned in the context.', 'answer': 'Tae Kwon Do Times'}) (input_keys=None)
</code></pre>
</div>
</div>
</section>
<section id="evaluate-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="evaluate-the-pipeline">Evaluate the Pipeline</h3>
<div id="cell-58" class="cell" data-execution_count="37">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.evaluate.evaluate <span class="im">import</span> Evaluate</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the `evaluate_on_hotpotqa` function. We'll use this many times below.</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>evaluate_on_hotpotqa <span class="op">=</span> Evaluate(</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    devset<span class="op">=</span>devset, num_threads<span class="op">=</span><span class="dv">1</span>, display_progress<span class="op">=</span><span class="va">False</span>, display_table<span class="op">=</span><span class="dv">5</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate the `compiled_rag` program with the `answer_exact_match` metric.</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>metric <span class="op">=</span> dspy.evaluate.answer_exact_match</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>evaluate_on_hotpotqa(compiled_rag, metric<span class="op">=</span>metric)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<style type="text/css">
#T_95624 th {
  text-align: left;
}
#T_95624 td {
  text-align: left;
}
#T_95624_row0_col0, #T_95624_row0_col1, #T_95624_row0_col2, #T_95624_row0_col3, #T_95624_row0_col4, #T_95624_row0_col5, #T_95624_row1_col0, #T_95624_row1_col1, #T_95624_row1_col2, #T_95624_row1_col3, #T_95624_row1_col4, #T_95624_row1_col5, #T_95624_row2_col0, #T_95624_row2_col1, #T_95624_row2_col2, #T_95624_row2_col3, #T_95624_row2_col4, #T_95624_row2_col5, #T_95624_row3_col0, #T_95624_row3_col1, #T_95624_row3_col2, #T_95624_row3_col3, #T_95624_row3_col4, #T_95624_row3_col5, #T_95624_row4_col0, #T_95624_row4_col1, #T_95624_row4_col2, #T_95624_row4_col3, #T_95624_row4_col4, #T_95624_row4_col5 {
  text-align: left;
  white-space: pre-wrap;
  word-wrap: break-word;
  max-width: 400px;
}
</style>

<table id="T_95624" data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_95624_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">question</th>
<th id="T_95624_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">example_answer</th>
<th id="T_95624_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">gold_titles</th>
<th id="T_95624_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">context</th>
<th id="T_95624_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">pred_answer</th>
<th id="T_95624_level0_col5" class="col_heading level0 col5" data-quarto-table-cell-role="th">answer_exact_match</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_95624_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">0</td>
<td id="T_95624_row0_col0" class="data row0 col0">Are both Cangzhou and Qionghai in the Hebei province of China?</td>
<td id="T_95624_row0_col1" class="data row0 col1">no</td>
<td id="T_95624_row0_col2" class="data row0 col2">{'Qionghai', 'Cangzhou'}</td>
<td id="T_95624_row0_col3" class="data row0 col3">['Cangzhou | Cangzhou () is a prefecture-level city in eastern Hebei province, People\'s Republic of China. At the 2010 census, Cangzhou\'s built-up ("or metro") area...</td>
<td id="T_95624_row0_col4" class="data row0 col4">Yes</td>
<td id="T_95624_row0_col5" class="data row0 col5">False</td>
</tr>
<tr class="even">
<td id="T_95624_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">1</td>
<td id="T_95624_row1_col0" class="data row1 col0">Who conducts the draft in which Marc-Andre Fleury was drafted to the Vegas Golden Knights for the 2017-18 season?</td>
<td id="T_95624_row1_col1" class="data row1 col1">National Hockey League</td>
<td id="T_95624_row1_col2" class="data row1 col2">{'2017 NHL Expansion Draft', '2017–18 Pittsburgh Penguins season'}</td>
<td id="T_95624_row1_col3" class="data row1 col3">['2017–18 Pittsburgh Penguins season | The 2017–18 Pittsburgh Penguins season will be the 51st season for the National Hockey League ice hockey team that was...</td>
<td id="T_95624_row1_col4" class="data row1 col4">National Hockey League</td>
<td id="T_95624_row1_col5" class="data row1 col5">✔️ [True]</td>
</tr>
<tr class="odd">
<td id="T_95624_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">2</td>
<td id="T_95624_row2_col0" class="data row2 col0">The Wings entered a new era, following the retirement of which Canadian retired professional ice hockey player and current general manager of the Tampa Bay...</td>
<td id="T_95624_row2_col1" class="data row2 col1">Steve Yzerman</td>
<td id="T_95624_row2_col2" class="data row2 col2">{'Steve Yzerman', '2006–07 Detroit Red Wings season'}</td>
<td id="T_95624_row2_col3" class="data row2 col3">['Steve Yzerman | Stephen Gregory "Steve" Yzerman ( ; born May 9, 1965) is a Canadian retired professional ice hockey player and current general manager...</td>
<td id="T_95624_row2_col4" class="data row2 col4">Steve Yzerman</td>
<td id="T_95624_row2_col5" class="data row2 col5">✔️ [True]</td>
</tr>
<tr class="even">
<td id="T_95624_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">3</td>
<td id="T_95624_row3_col0" class="data row3 col0">What river is near the Crichton Collegiate Church?</td>
<td id="T_95624_row3_col1" class="data row3 col1">the River Tyne</td>
<td id="T_95624_row3_col2" class="data row3 col2">{'Crichton Collegiate Church', 'Crichton Castle'}</td>
<td id="T_95624_row3_col3" class="data row3 col3">["Crichton Collegiate Church | Crichton Collegiate Church is situated about 0.6 mi south west of the hamlet of Crichton in Midlothian, Scotland. Crichton itself is...</td>
<td id="T_95624_row3_col4" class="data row3 col4">River Tyne</td>
<td id="T_95624_row3_col5" class="data row3 col5">✔️ [True]</td>
</tr>
<tr class="odd">
<td id="T_95624_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">4</td>
<td id="T_95624_row4_col0" class="data row4 col0">In the 10th Century A.D. Ealhswith had a son called Æthelweard by which English king?</td>
<td id="T_95624_row4_col1" class="data row4 col1">King Alfred the Great</td>
<td id="T_95624_row4_col2" class="data row4 col2">{'Æthelweard (son of Alfred)', 'Ealhswith'}</td>
<td id="T_95624_row4_col3" class="data row4 col3">["Æthelweard of East Anglia | Æthelweard (died 854) was a 9th-century king of East Anglia, the long-lived Anglo-Saxon kingdom which today includes the English counties...</td>
<td id="T_95624_row4_col4" class="data row4 col4">Alfred the Great</td>
<td id="T_95624_row4_col5" class="data row4 col5">False</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell-output cell-output-display">

                <div style="
                    text-align: center;
                    font-size: 16px;
                    font-weight: bold;
                    color: #555;
                    margin: 10px 0;">
                    ... 45 more rows not displayed ...
                </div>
                
</div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>48.0</code></pre>
</div>
</div>
</section>
<section id="evaluate-retrieval" class="level3">
<h3 class="anchored" data-anchor-id="evaluate-retrieval">Evaluate Retrieval</h3>
<div id="cell-60" class="cell" data-execution_count="38">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gold_passages_retrieved(example, pred, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    gold_titles <span class="op">=</span> <span class="bu">set</span>(<span class="bu">map</span>(dspy.evaluate.normalize_text, example[<span class="st">"gold_titles"</span>]))</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    found_titles <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">map</span>(dspy.evaluate.normalize_text, [c.split(<span class="st">" | "</span>)[<span class="dv">0</span>] <span class="cf">for</span> c <span class="kw">in</span> pred.context])</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gold_titles.issubset(found_titles)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>compiled_rag_retrieval_score <span class="op">=</span> evaluate_on_hotpotqa(</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    compiled_rag, metric<span class="op">=</span>gold_passages_retrieved</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<style type="text/css">
#T_54c59 th {
  text-align: left;
}
#T_54c59 td {
  text-align: left;
}
#T_54c59_row0_col0, #T_54c59_row0_col1, #T_54c59_row0_col2, #T_54c59_row0_col3, #T_54c59_row0_col4, #T_54c59_row0_col5, #T_54c59_row1_col0, #T_54c59_row1_col1, #T_54c59_row1_col2, #T_54c59_row1_col3, #T_54c59_row1_col4, #T_54c59_row1_col5, #T_54c59_row2_col0, #T_54c59_row2_col1, #T_54c59_row2_col2, #T_54c59_row2_col3, #T_54c59_row2_col4, #T_54c59_row2_col5, #T_54c59_row3_col0, #T_54c59_row3_col1, #T_54c59_row3_col2, #T_54c59_row3_col3, #T_54c59_row3_col4, #T_54c59_row3_col5, #T_54c59_row4_col0, #T_54c59_row4_col1, #T_54c59_row4_col2, #T_54c59_row4_col3, #T_54c59_row4_col4, #T_54c59_row4_col5 {
  text-align: left;
  white-space: pre-wrap;
  word-wrap: break-word;
  max-width: 400px;
}
</style>

<table id="T_54c59" data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_54c59_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">question</th>
<th id="T_54c59_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">example_answer</th>
<th id="T_54c59_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">gold_titles</th>
<th id="T_54c59_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">context</th>
<th id="T_54c59_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">pred_answer</th>
<th id="T_54c59_level0_col5" class="col_heading level0 col5" data-quarto-table-cell-role="th">gold_passages_retrieved</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_54c59_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">0</td>
<td id="T_54c59_row0_col0" class="data row0 col0">Are both Cangzhou and Qionghai in the Hebei province of China?</td>
<td id="T_54c59_row0_col1" class="data row0 col1">no</td>
<td id="T_54c59_row0_col2" class="data row0 col2">{'Qionghai', 'Cangzhou'}</td>
<td id="T_54c59_row0_col3" class="data row0 col3">['Cangzhou | Cangzhou () is a prefecture-level city in eastern Hebei province, People\'s Republic of China. At the 2010 census, Cangzhou\'s built-up ("or metro") area...</td>
<td id="T_54c59_row0_col4" class="data row0 col4">Yes</td>
<td id="T_54c59_row0_col5" class="data row0 col5">False</td>
</tr>
<tr class="even">
<td id="T_54c59_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">1</td>
<td id="T_54c59_row1_col0" class="data row1 col0">Who conducts the draft in which Marc-Andre Fleury was drafted to the Vegas Golden Knights for the 2017-18 season?</td>
<td id="T_54c59_row1_col1" class="data row1 col1">National Hockey League</td>
<td id="T_54c59_row1_col2" class="data row1 col2">{'2017 NHL Expansion Draft', '2017–18 Pittsburgh Penguins season'}</td>
<td id="T_54c59_row1_col3" class="data row1 col3">['2017–18 Pittsburgh Penguins season | The 2017–18 Pittsburgh Penguins season will be the 51st season for the National Hockey League ice hockey team that was...</td>
<td id="T_54c59_row1_col4" class="data row1 col4">National Hockey League</td>
<td id="T_54c59_row1_col5" class="data row1 col5">✔️ [True]</td>
</tr>
<tr class="odd">
<td id="T_54c59_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">2</td>
<td id="T_54c59_row2_col0" class="data row2 col0">The Wings entered a new era, following the retirement of which Canadian retired professional ice hockey player and current general manager of the Tampa Bay...</td>
<td id="T_54c59_row2_col1" class="data row2 col1">Steve Yzerman</td>
<td id="T_54c59_row2_col2" class="data row2 col2">{'Steve Yzerman', '2006–07 Detroit Red Wings season'}</td>
<td id="T_54c59_row2_col3" class="data row2 col3">['Steve Yzerman | Stephen Gregory "Steve" Yzerman ( ; born May 9, 1965) is a Canadian retired professional ice hockey player and current general manager...</td>
<td id="T_54c59_row2_col4" class="data row2 col4">Steve Yzerman</td>
<td id="T_54c59_row2_col5" class="data row2 col5">✔️ [True]</td>
</tr>
<tr class="even">
<td id="T_54c59_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">3</td>
<td id="T_54c59_row3_col0" class="data row3 col0">What river is near the Crichton Collegiate Church?</td>
<td id="T_54c59_row3_col1" class="data row3 col1">the River Tyne</td>
<td id="T_54c59_row3_col2" class="data row3 col2">{'Crichton Collegiate Church', 'Crichton Castle'}</td>
<td id="T_54c59_row3_col3" class="data row3 col3">["Crichton Collegiate Church | Crichton Collegiate Church is situated about 0.6 mi south west of the hamlet of Crichton in Midlothian, Scotland. Crichton itself is...</td>
<td id="T_54c59_row3_col4" class="data row3 col4">River Tyne</td>
<td id="T_54c59_row3_col5" class="data row3 col5">✔️ [True]</td>
</tr>
<tr class="odd">
<td id="T_54c59_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">4</td>
<td id="T_54c59_row4_col0" class="data row4 col0">In the 10th Century A.D. Ealhswith had a son called Æthelweard by which English king?</td>
<td id="T_54c59_row4_col1" class="data row4 col1">King Alfred the Great</td>
<td id="T_54c59_row4_col2" class="data row4 col2">{'Æthelweard (son of Alfred)', 'Ealhswith'}</td>
<td id="T_54c59_row4_col3" class="data row4 col3">["Æthelweard of East Anglia | Æthelweard (died 854) was a 9th-century king of East Anglia, the long-lived Anglo-Saxon kingdom which today includes the English counties...</td>
<td id="T_54c59_row4_col4" class="data row4 col4">Alfred the Great</td>
<td id="T_54c59_row4_col5" class="data row4 col5">False</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell-output cell-output-display">

                <div style="
                    text-align: center;
                    font-size: 16px;
                    font-weight: bold;
                    color: #555;
                    margin: 10px 0;">
                    ... 45 more rows not displayed ...
                </div>
                
</div>
</div>
</section>
</section>
<section id="multi-hop-question-answering" class="level2">
<h2 class="anchored" data-anchor-id="multi-hop-question-answering">Multi-Hop Question-Answering</h2>
<div id="cell-62" class="cell" data-execution_count="39">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>turbo <span class="op">=</span> dspy.OpenAI(model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>colbertv2_wiki17_abstracts <span class="op">=</span> dspy.ColBERTv2(</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    url<span class="op">=</span><span class="st">"http://20.102.90.50:2017/wiki17_abstracts"</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>dspy.settings.configure(lm<span class="op">=</span>turbo, rm<span class="op">=</span>colbertv2_wiki17_abstracts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-63" class="cell" data-execution_count="40">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.datasets <span class="im">import</span> HotPotQA</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dataset.</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> HotPotQA(</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    train_seed<span class="op">=</span><span class="dv">1</span>, train_size<span class="op">=</span><span class="dv">20</span>, eval_seed<span class="op">=</span><span class="dv">2023</span>, dev_size<span class="op">=</span><span class="dv">50</span>, test_size<span class="op">=</span><span class="dv">0</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Tell DSPy that the 'question' field is the input. Any other fields are labels and/or metadata.</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>trainset <span class="op">=</span> [x.with_inputs(<span class="st">"question"</span>) <span class="cf">for</span> x <span class="kw">in</span> dataset.train]</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>devset <span class="op">=</span> [x.with_inputs(<span class="st">"question"</span>) <span class="cf">for</span> x <span class="kw">in</span> dataset.dev]</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(trainset), <span class="bu">len</span>(devset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/dothomps/.pyenv/versions/3.11.9/envs/blog/lib/python3.11/site-packages/datasets/table.py:1421: FutureWarning: promote has been superseded by promote_options='default'.
  table = cls._concat_blocks(blocks, axis=0)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>(20, 50)</code></pre>
</div>
</div>
<div id="cell-64" class="cell" data-execution_count="41">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GenerateAnswer(dspy.Signature):</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Answer questions with short factoid answers."""</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"may contain relevant facts"</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    question <span class="op">=</span> dspy.InputField()</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    answer <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"often between 1 and 5 words"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-65" class="cell" data-execution_count="42">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GenerateSearchQuery(dspy.Signature):</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Write a simple search query that will help answer a complex question."""</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"may contain relevant facts"</span>)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    question <span class="op">=</span> dspy.InputField()</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> dspy.OutputField()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-66" class="cell" data-execution_count="43">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dsp.utils <span class="im">import</span> deduplicate</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimplifiedBaleen(dspy.Module):</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, passages_per_hop<span class="op">=</span><span class="dv">3</span>, max_hops<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.generate_query <span class="op">=</span> [</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>            dspy.ChainOfThought(GenerateSearchQuery) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(max_hops)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.retrieve <span class="op">=</span> dspy.Retrieve(k<span class="op">=</span>passages_per_hop)</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.generate_answer <span class="op">=</span> dspy.ChainOfThought(GenerateAnswer)</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_hops <span class="op">=</span> max_hops</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, question):</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>        context <span class="op">=</span> []</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> hop <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.max_hops):</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>            query <span class="op">=</span> <span class="va">self</span>.generate_query[hop](context<span class="op">=</span>context, question<span class="op">=</span>question).query</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>            passages <span class="op">=</span> <span class="va">self</span>.retrieve(query).passages</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>            context <span class="op">=</span> deduplicate(context <span class="op">+</span> passages)</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>        pred <span class="op">=</span> <span class="va">self</span>.generate_answer(context<span class="op">=</span>context, question<span class="op">=</span>question)</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dspy.Prediction(context<span class="op">=</span>context, answer<span class="op">=</span>pred.answer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-67" class="cell" data-execution_count="44">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ask any question you like to this simple RAG program.</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>my_question <span class="op">=</span> <span class="st">"How many storeys are in the castle that David Gregory inherited?"</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the prediction. This contains `pred.context` and `pred.answer`.</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>uncompiled_baleen <span class="op">=</span> SimplifiedBaleen()  <span class="co"># uncompiled (i.e., zero-shot) program</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> uncompiled_baleen(my_question)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the contexts and the answer.</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>my_question<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Predicted Answer: </span><span class="sc">{</span>pred<span class="sc">.</span>answer<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Retrieved Contexts (truncated): </span><span class="sc">{</span>[c[:<span class="dv">200</span>] <span class="op">+</span> <span class="st">'...'</span> <span class="cf">for</span> c <span class="kw">in</span> pred.context]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Question: How many storeys are in the castle that David Gregory inherited?
Predicted Answer: five
Retrieved Contexts (truncated): ['David Gregory (physician) | David Gregory (20 December 1625 – 1720) was a Scottish physician and inventor. His surname is sometimes spelt as Gregorie, the original Scottish spelling. He inherited Kinn...', 'Cantacuzino Castle | Cantacuzino Castle is situated on Zamora Street in Bușteni, Romania. The building, whose construction was completed in 1911, was conducted by the architect Gregory Cerchez at the ...', 'Gregory Tarchaneiotes | Gregory Tarchaneiotes (Greek: Γρηγόριος Ταρχανειώτης , Italian: "Gregorio Tracanioto" or "Tracamoto" ) was a "protospatharius" and the long-reigning catepan of Italy from 998 t...', 'Kinnairdy Castle | Kinnairdy Castle is a tower house, having five storeys and a garret, two miles south of Aberchirder, Aberdeenshire, Scotland. The alternative name is Old Kinnairdy....', 'Kinnordy House | Kinnordy House (alternative spellings: Kynnordy, Kinardy, Kinnordie and Kinorde) is an estate house near Kirriemuir in Angus, Scotland. The first house was built in the 1680s, when In...']</code></pre>
</div>
</div>
<div id="cell-68" class="cell" data-execution_count="45">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_context_and_answer_and_hops(example, pred, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> dspy.evaluate.answer_exact_match(example, pred):</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> dspy.evaluate.answer_passage_match(example, pred):</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    hops <span class="op">=</span> [example.question] <span class="op">+</span> [</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>        outputs.query <span class="cf">for</span> <span class="op">*</span>_, outputs <span class="kw">in</span> trace <span class="cf">if</span> <span class="st">"query"</span> <span class="kw">in</span> outputs</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">max</span>([<span class="bu">len</span>(h) <span class="cf">for</span> h <span class="kw">in</span> hops]) <span class="op">&gt;</span> <span class="dv">100</span>:</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">any</span>(</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>        dspy.evaluate.answer_exact_match_str(hops[idx], hops[:idx], frac<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>, <span class="bu">len</span>(hops))</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-69" class="cell" data-execution_count="46">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.teleprompt <span class="im">import</span> BootstrapFewShot</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>teleprompter <span class="op">=</span> BootstrapFewShot(metric<span class="op">=</span>validate_context_and_answer_and_hops)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>compiled_baleen <span class="op">=</span> teleprompter.<span class="bu">compile</span>(</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    SimplifiedBaleen(), teacher<span class="op">=</span>SimplifiedBaleen(passages_per_hop<span class="op">=</span><span class="dv">2</span>), trainset<span class="op">=</span>trainset</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code> 90%|█████████ | 18/20 [00:00&lt;00:00, 37.83it/s]</code></pre>
</div>
</div>
<div id="cell-70" class="cell" data-execution_count="48">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.evaluate.evaluate <span class="im">import</span> Evaluate</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define metric to check if we retrieved the correct documents</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gold_passages_retrieved(example, pred, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    gold_titles <span class="op">=</span> <span class="bu">set</span>(<span class="bu">map</span>(dspy.evaluate.normalize_text, example[<span class="st">"gold_titles"</span>]))</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    found_titles <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">map</span>(dspy.evaluate.normalize_text, [c.split(<span class="st">" | "</span>)[<span class="dv">0</span>] <span class="cf">for</span> c <span class="kw">in</span> pred.context])</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gold_titles.issubset(found_titles)</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the `evaluate_on_hotpotqa` function. We'll use this many times below.</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>evaluate_on_hotpotqa <span class="op">=</span> Evaluate(</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>    devset<span class="op">=</span>devset, num_threads<span class="op">=</span><span class="dv">1</span>, display_progress<span class="op">=</span><span class="va">True</span>, display_table<span class="op">=</span><span class="dv">5</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>uncompiled_baleen_retrieval_score <span class="op">=</span> evaluate_on_hotpotqa(</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>    uncompiled_baleen, metric<span class="op">=</span>gold_passages_retrieved,</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>compiled_baleen_retrieval_score <span class="op">=</span> evaluate_on_hotpotqa(</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>    compiled_baleen, metric<span class="op">=</span>gold_passages_retrieved</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"## Retrieval Score for uncompiled Baleen: </span><span class="sc">{</span>uncompiled_baleen_retrieval_score<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"## Retrieval Score for compiled Baleen: </span><span class="sc">{</span>compiled_baleen_retrieval_score<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 23 / 50  (46.0): 100%|██████████| 50/50 [03:37&lt;00:00,  4.35s/it]
Average Metric: 32 / 50  (64.0): 100%|██████████| 50/50 [03:40&lt;00:00,  4.42s/it]
## Retrieval Score for uncompiled Baleen: 46.0
## Retrieval Score for compiled Baleen: 64.0</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<style type="text/css">
#T_e8031 th {
  text-align: left;
}
#T_e8031 td {
  text-align: left;
}
#T_e8031_row0_col0, #T_e8031_row0_col1, #T_e8031_row0_col2, #T_e8031_row0_col3, #T_e8031_row0_col4, #T_e8031_row0_col5, #T_e8031_row1_col0, #T_e8031_row1_col1, #T_e8031_row1_col2, #T_e8031_row1_col3, #T_e8031_row1_col4, #T_e8031_row1_col5, #T_e8031_row2_col0, #T_e8031_row2_col1, #T_e8031_row2_col2, #T_e8031_row2_col3, #T_e8031_row2_col4, #T_e8031_row2_col5, #T_e8031_row3_col0, #T_e8031_row3_col1, #T_e8031_row3_col2, #T_e8031_row3_col3, #T_e8031_row3_col4, #T_e8031_row3_col5, #T_e8031_row4_col0, #T_e8031_row4_col1, #T_e8031_row4_col2, #T_e8031_row4_col3, #T_e8031_row4_col4, #T_e8031_row4_col5 {
  text-align: left;
  white-space: pre-wrap;
  word-wrap: break-word;
  max-width: 400px;
}
</style>

<table id="T_e8031" data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_e8031_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">question</th>
<th id="T_e8031_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">example_answer</th>
<th id="T_e8031_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">gold_titles</th>
<th id="T_e8031_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">context</th>
<th id="T_e8031_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">pred_answer</th>
<th id="T_e8031_level0_col5" class="col_heading level0 col5" data-quarto-table-cell-role="th">gold_passages_retrieved</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_e8031_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">0</td>
<td id="T_e8031_row0_col0" class="data row0 col0">Are both Cangzhou and Qionghai in the Hebei province of China?</td>
<td id="T_e8031_row0_col1" class="data row0 col1">no</td>
<td id="T_e8031_row0_col2" class="data row0 col2">{'Qionghai', 'Cangzhou'}</td>
<td id="T_e8031_row0_col3" class="data row0 col3">['Qionghai | Qionghai () is one of the seven county-level cities of Hainan province, China. Although called a "city", Qionghai refers to a large land...</td>
<td id="T_e8031_row0_col4" class="data row0 col4">No</td>
<td id="T_e8031_row0_col5" class="data row0 col5">False</td>
</tr>
<tr class="even">
<td id="T_e8031_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">1</td>
<td id="T_e8031_row1_col0" class="data row1 col0">Who conducts the draft in which Marc-Andre Fleury was drafted to the Vegas Golden Knights for the 2017-18 season?</td>
<td id="T_e8031_row1_col1" class="data row1 col1">National Hockey League</td>
<td id="T_e8031_row1_col2" class="data row1 col2">{'2017 NHL Expansion Draft', '2017–18 Pittsburgh Penguins season'}</td>
<td id="T_e8031_row1_col3" class="data row1 col3">["2017 NHL Expansion Draft | The 2017 NHL Expansion Draft was an expansion draft conducted by the National Hockey League on June 18–20, 2017 to...</td>
<td id="T_e8031_row1_col4" class="data row1 col4">National Hockey League</td>
<td id="T_e8031_row1_col5" class="data row1 col5">✔️ [True]</td>
</tr>
<tr class="odd">
<td id="T_e8031_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">2</td>
<td id="T_e8031_row2_col0" class="data row2 col0">The Wings entered a new era, following the retirement of which Canadian retired professional ice hockey player and current general manager of the Tampa Bay...</td>
<td id="T_e8031_row2_col1" class="data row2 col1">Steve Yzerman</td>
<td id="T_e8031_row2_col2" class="data row2 col2">{'Steve Yzerman', '2006–07 Detroit Red Wings season'}</td>
<td id="T_e8031_row2_col3" class="data row2 col3">['Steve Yzerman | Stephen Gregory "Steve" Yzerman ( ; born May 9, 1965) is a Canadian retired professional ice hockey player and current general manager...</td>
<td id="T_e8031_row2_col4" class="data row2 col4">Steve Yzerman</td>
<td id="T_e8031_row2_col5" class="data row2 col5">False</td>
</tr>
<tr class="even">
<td id="T_e8031_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">3</td>
<td id="T_e8031_row3_col0" class="data row3 col0">What river is near the Crichton Collegiate Church?</td>
<td id="T_e8031_row3_col1" class="data row3 col1">the River Tyne</td>
<td id="T_e8031_row3_col2" class="data row3 col2">{'Crichton Collegiate Church', 'Crichton Castle'}</td>
<td id="T_e8031_row3_col3" class="data row3 col3">['River Esk, Dumfries and Galloway | The River Esk (Scottish Gaelic: "Easg" ), also called the Border Esk, is a river in Dumfries and Galloway,...</td>
<td id="T_e8031_row3_col4" class="data row3 col4">River Nith</td>
<td id="T_e8031_row3_col5" class="data row3 col5">False</td>
</tr>
<tr class="odd">
<td id="T_e8031_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">4</td>
<td id="T_e8031_row4_col0" class="data row4 col0">In the 10th Century A.D. Ealhswith had a son called Æthelweard by which English king?</td>
<td id="T_e8031_row4_col1" class="data row4 col1">King Alfred the Great</td>
<td id="T_e8031_row4_col2" class="data row4 col2">{'Æthelweard (son of Alfred)', 'Ealhswith'}</td>
<td id="T_e8031_row4_col3" class="data row4 col3">['10th century in England | Events from the 10th century in the Kingdom of England.', 'Beorhtnoð æthling of Kent | Beorhtnoð æthling of Kent was...</td>
<td id="T_e8031_row4_col4" class="data row4 col4">King Alfred the Great</td>
<td id="T_e8031_row4_col5" class="data row4 col5">✔️ [True]</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell-output cell-output-display">

                <div style="
                    text-align: center;
                    font-size: 16px;
                    font-weight: bold;
                    color: #555;
                    margin: 10px 0;">
                    ... 45 more rows not displayed ...
                </div>
                
</div>
<div class="cell-output cell-output-display">
<div>
<style type="text/css">
#T_b2589 th {
  text-align: left;
}
#T_b2589 td {
  text-align: left;
}
#T_b2589_row0_col0, #T_b2589_row0_col1, #T_b2589_row0_col2, #T_b2589_row0_col3, #T_b2589_row0_col4, #T_b2589_row0_col5, #T_b2589_row1_col0, #T_b2589_row1_col1, #T_b2589_row1_col2, #T_b2589_row1_col3, #T_b2589_row1_col4, #T_b2589_row1_col5, #T_b2589_row2_col0, #T_b2589_row2_col1, #T_b2589_row2_col2, #T_b2589_row2_col3, #T_b2589_row2_col4, #T_b2589_row2_col5, #T_b2589_row3_col0, #T_b2589_row3_col1, #T_b2589_row3_col2, #T_b2589_row3_col3, #T_b2589_row3_col4, #T_b2589_row3_col5, #T_b2589_row4_col0, #T_b2589_row4_col1, #T_b2589_row4_col2, #T_b2589_row4_col3, #T_b2589_row4_col4, #T_b2589_row4_col5 {
  text-align: left;
  white-space: pre-wrap;
  word-wrap: break-word;
  max-width: 400px;
}
</style>

<table id="T_b2589" data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_b2589_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">question</th>
<th id="T_b2589_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">example_answer</th>
<th id="T_b2589_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">gold_titles</th>
<th id="T_b2589_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">context</th>
<th id="T_b2589_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">pred_answer</th>
<th id="T_b2589_level0_col5" class="col_heading level0 col5" data-quarto-table-cell-role="th">gold_passages_retrieved</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_b2589_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">0</td>
<td id="T_b2589_row0_col0" class="data row0 col0">Are both Cangzhou and Qionghai in the Hebei province of China?</td>
<td id="T_b2589_row0_col1" class="data row0 col1">no</td>
<td id="T_b2589_row0_col2" class="data row0 col2">{'Qionghai', 'Cangzhou'}</td>
<td id="T_b2589_row0_col3" class="data row0 col3">['Cangzhou | Cangzhou () is a prefecture-level city in eastern Hebei province, People\'s Republic of China. At the 2010 census, Cangzhou\'s built-up ("or metro") area...</td>
<td id="T_b2589_row0_col4" class="data row0 col4">No</td>
<td id="T_b2589_row0_col5" class="data row0 col5">✔️ [True]</td>
</tr>
<tr class="even">
<td id="T_b2589_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">1</td>
<td id="T_b2589_row1_col0" class="data row1 col0">Who conducts the draft in which Marc-Andre Fleury was drafted to the Vegas Golden Knights for the 2017-18 season?</td>
<td id="T_b2589_row1_col1" class="data row1 col1">National Hockey League</td>
<td id="T_b2589_row1_col2" class="data row1 col2">{'2017 NHL Expansion Draft', '2017–18 Pittsburgh Penguins season'}</td>
<td id="T_b2589_row1_col3" class="data row1 col3">['2017 NHL Entry Draft | The 2017 NHL Entry Draft was the 55th NHL Entry Draft. The draft was held from June 23–24, 2017, at...</td>
<td id="T_b2589_row1_col4" class="data row1 col4">2017 NHL Entry Draft</td>
<td id="T_b2589_row1_col5" class="data row1 col5">False</td>
</tr>
<tr class="odd">
<td id="T_b2589_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">2</td>
<td id="T_b2589_row2_col0" class="data row2 col0">The Wings entered a new era, following the retirement of which Canadian retired professional ice hockey player and current general manager of the Tampa Bay...</td>
<td id="T_b2589_row2_col1" class="data row2 col1">Steve Yzerman</td>
<td id="T_b2589_row2_col2" class="data row2 col2">{'Steve Yzerman', '2006–07 Detroit Red Wings season'}</td>
<td id="T_b2589_row2_col3" class="data row2 col3">['Steve Yzerman | Stephen Gregory "Steve" Yzerman ( ; born May 9, 1965) is a Canadian retired professional ice hockey player and current general manager...</td>
<td id="T_b2589_row2_col4" class="data row2 col4">Steve Yzerman</td>
<td id="T_b2589_row2_col5" class="data row2 col5">False</td>
</tr>
<tr class="even">
<td id="T_b2589_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">3</td>
<td id="T_b2589_row3_col0" class="data row3 col0">What river is near the Crichton Collegiate Church?</td>
<td id="T_b2589_row3_col1" class="data row3 col1">the River Tyne</td>
<td id="T_b2589_row3_col2" class="data row3 col2">{'Crichton Collegiate Church', 'Crichton Castle'}</td>
<td id="T_b2589_row3_col3" class="data row3 col3">["Crichton Collegiate Church | Crichton Collegiate Church is situated about 0.6 mi south west of the hamlet of Crichton in Midlothian, Scotland. Crichton itself is...</td>
<td id="T_b2589_row3_col4" class="data row3 col4">River Tyne</td>
<td id="T_b2589_row3_col5" class="data row3 col5">✔️ [True]</td>
</tr>
<tr class="odd">
<td id="T_b2589_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">4</td>
<td id="T_b2589_row4_col0" class="data row4 col0">In the 10th Century A.D. Ealhswith had a son called Æthelweard by which English king?</td>
<td id="T_b2589_row4_col1" class="data row4 col1">King Alfred the Great</td>
<td id="T_b2589_row4_col2" class="data row4 col2">{'Æthelweard (son of Alfred)', 'Ealhswith'}</td>
<td id="T_b2589_row4_col3" class="data row4 col3">['Æthelstan | Æthelstan or Athelstan (Old English: "Æþelstan" , "Æðelstān" , meaning "noble stone"; 89427 October 939) was King of the Anglo-Saxons from 924 to...</td>
<td id="T_b2589_row4_col4" class="data row4 col4">King Alfred the Great</td>
<td id="T_b2589_row4_col5" class="data row4 col5">✔️ [True]</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell-output cell-output-display">

                <div style="
                    text-align: center;
                    font-size: 16px;
                    font-weight: bold;
                    color: #555;
                    margin: 10px 0;">
                    ... 45 more rows not displayed ...
                </div>
                
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/witt3rd\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>